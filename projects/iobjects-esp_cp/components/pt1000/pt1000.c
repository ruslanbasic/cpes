/******************************************************************************
 * @copyright Copyright (c) A1 Company LLC. All rights reserved.
 *****************************************************************************/

#include "pt1000.h"
#include <math.h>
#include "esp_err.h"

//static const float PT1000[150] = { //resistance <-> temperature table
///*         0       1       2       3       4       5       6       7       8       9 */
///* -20*/ 921.6,  925.53, 929.46, 933.39, 937.32, 941.24, 945.17, 949.09, 953.02, 956.94,
///* -10*/ 960.86, 964.78, 968.7,  972.61, 976.53, 980.44, 984.36, 988.27, 992.18, 996.09,
///*   0*/ 1000,   1003.9, 1007.8, 1011.7, 1015.6, 1019.5, 1023.4, 1027.3, 1031.2, 1035.1,
///* +10*/ 1039,   1042.9, 1046.8, 1050.7, 1054.6, 1058.5, 1062.4, 1066.3, 1070.2, 1074,
///* +20*/ 1077.9, 1081.8, 1085.7, 1089.6, 1093.5, 1097.3, 1101.2, 1105.1, 1109,   1112.9,
///* +30*/ 1116.7, 1120.6, 1124.5, 1128.3, 1132.2, 1136.1, 1140,   1143.8, 1147.7, 1151.5,
///* +40*/ 1155.4, 1159.3, 1163.1, 1167,   1170.8, 1174.7, 1178.6, 1182.4, 1186.3, 1190.1,
///* +50*/ 1194,   1197.8, 1201.7, 1205.5, 1209.4, 1213.2, 1217.1, 1220.9, 1224.7, 1228.6,
///* +60*/ 1232.4, 1236.3, 1240.1, 1243.9, 1247.8, 1251.6, 1255.4, 1259.3, 1263.1, 1266.9,
///* +70*/ 1270.8, 1274.6, 1278.4, 1282.2, 1286.1, 1289.9, 1293.7, 1297.5, 1301.3, 1305.2,
///* +80*/ 1309,   1312.8, 1316.6, 1320.4, 1324.2, 1328,   1331.8, 1335.7, 1339.5, 1343.3,
///* +90*/ 1347.1, 1350.9, 1354.7, 1358.5, 1362.3, 1366.1, 1369.9, 1373.7, 1377.5, 1381.3,
///*+100*/ 1385.1, 1388.8, 1392.6, 1396.4, 1400.2, 1404,   1407.8, 1411.6, 1415.4, 1419.1,
///*+110*/ 1422.9, 1426.7, 1430.5, 1434.3, 1438,   1441.8, 1445.6, 1449.4, 1453.1, 1456.9,
///*+120*/ 1460.7, 1464.4, 1468.2, 1472,   1475.8, 1479.5, 1483.3, 1487,   1490.8, 1494.6,
//};

static const float PT1000[][2] =
{
  {  -10.0, 960.86 },
  {   -9.0, 964.78 },
  {   -8.0, 968.7  },
  {   -7.0, 972.61 },
  {   -6.0, 976.53 },
  {   -5.0, 980.44 },
  {   -4.0, 984.36 },
  {   -3.0, 988.27 },
  {   -2.0, 992.18 },
  {   -1.0, 996.09 },
  {    0.0, 1000   },
  {   +1.0, 1003.9 },
  {   +2.0, 1007.8 },
  {   +3.0, 1011.7 },
  {   +4.0, 1015.6 },
  {   +5.0, 1019.5 },
  {   +6.0, 1023.4 },
  {   +7.0, 1027.3 },
  {   +8.0, 1031.2 },
  {   +9.0, 1035.1 },
  {  +10.0, 1039   },
  {  +11.0, 1042.9 },
  {  +12.0, 1046.8 },
  {  +13.0, 1050.7 },
  {  +14.0, 1054.6 },
  {  +15.0, 1058.5 },
  {  +16.0, 1062.4 },
  {  +17.0, 1066.3 },
  {  +18.0, 1070.2 },
  {  +19.0, 1074   },
  {  +20.0, 1077.9 },
  {  +21.0, 1081.8 },
  {  +22.0, 1085.7 },
  {  +23.0, 1089.6 },
  {  +24.0, 1093.5 },
  {  +25.0, 1097.3 },
  {  +26.0, 1101.2 },
  {  +27.0, 1105.1 },
  {  +28.0, 1109   },
  {  +29.0, 1112.9 },
  {  +30.0, 1116.7 },
  {  +31.0, 1120.6 },
  {  +32.0, 1124.5 },
  {  +33.0, 1128.3 },
  {  +34.0, 1132.2 },
  {  +35.0, 1136.1 },
  {  +36.0, 1140   },
  {  +37.0, 1143.8 },
  {  +38.0, 1147.7 },
  {  +39.0, 1151.5 },
  {  +40.0, 1155.4 },
  {  +41.0, 1159.3 },
  {  +42.0, 1163.1 },
  {  +43.0, 1167   },
  {  +44.0, 1170.8 },
  {  +45.0, 1174.7 },
  {  +46.0, 1178.6 },
  {  +47.0, 1182.4 },
  {  +48.0, 1186.3 },
  {  +49.0, 1190.1 },
  {  +50.0, 1194   },
  {  +51.0, 1197.8 },
  {  +52.0, 1201.7 },
  {  +53.0, 1205.5 },
  {  +54.0, 1209.4 },
  {  +55.0, 1213.2 },
  {  +56.0, 1217.1 },
  {  +57.0, 1220.9 },
  {  +58.0, 1224.7 },
  {  +59.0, 1228.6 },
  {  +60.0, 1232.4 },
  {  +61.0, 1236.3 },
  {  +62.0, 1240.1 },
  {  +63.0, 1243.9 },
  {  +64.0, 1247.8 },
  {  +65.0, 1251.6 },
  {  +66.0, 1255.4 },
  {  +67.0, 1259.3 },
  {  +68.0, 1263.1 },
  {  +69.0, 1266.9 },
  {  +70.0, 1270.8 },
  {  +71.0, 1274.6 },
  {  +72.0, 1278.4 },
  {  +73.0, 1282.2 },
  {  +74.0, 1286.1 },
  {  +75.0, 1289.9 },
  {  +76.0, 1293.7 },
  {  +77.0, 1297.5 },
  {  +78.0, 1301.3 },
  {  +79.0, 1305.2 },
  {  +80.0, 1309   },
  {  +81.0, 1312.8 },
  {  +82.0, 1316.6 },
  {  +83.0, 1320.4 },
  {  +84.0, 1324.2 },
  {  +85.0, 1328   },
  {  +86.0, 1331.8 },
  {  +87.0, 1335.7 },
  {  +88.0, 1339.5 },
  {  +89.0, 1343.3 },
  {  +90.0, 1347.1 },
  {  +91.0, 1350.9 },
  {  +92.0, 1354.7 },
  {  +93.0, 1358.5 },
  {  +94.0, 1362.3 },
  {  +95.0, 1366.1 },
  {  +96.0, 1369.9 },
  {  +97.0, 1373.7 },
  {  +98.0, 1377.5 },
  {  +99.0, 1381.3 },
  { +100.0, 1385.1 },
  { +101.0, 1388.8 },
  { +102.0, 1392.6 },
  { +103.0, 1396.4 },
  { +104.0, 1400.2 },
  { +105.0, 1404   },
  { +106.0, 1407.8 },
  { +107.0, 1411.6 },
  { +108.0, 1415.4 },
  { +109.0, 1419.1 },
  { +110.0, 1422.9 },
  { +111.0, 1426.7 },
  { +112.0, 1430.5 },
  { +113.0, 1434.3 },
  { +114.0, 1438   },
  { +115.0, 1441.8 },
  { +116.0, 1445.6 },
  { +117.0, 1449.4 },
  { +118.0, 1453.1 },
  { +119.0, 1456.9 },
  { +120.0, 1460.7 },
};

bool pt1000_initialize(adc1_channel_t adc_channel)
{
  bool err = false;

  ESP_ERROR_CHECK(adc1_config_width(ADC_WIDTH_12Bit));
  esp_err_t adc_error = adc1_config_channel_atten(adc_channel, ADC_ATTEN_11db);
  if(adc_error == ESP_ERR_INVALID_ARG)
  {
    printf("pt1000: incorrect channel or attenuation\n");
    err = true;
  }
  return err;
}

//I=Uadc/R1=(3.26-Uadc)/1000, R=(Uadc*1000)/(3.2-Uadc)
float pt1000_get_temperature(adc1_channel_t adc_channel)
{
  float temperature = 0;

  float adc_value = (float)adc1_get_raw(adc_channel);
  //printf("adc_value = %4.2f\n", adc_value);

//  float voltage = (adc_value * 1.7f) / 916; //1V7 = 916
//  float resistance = (voltage * 1000) / (3.2f - voltage);

//  float voltage = (adc_value * 1.8f) / 952; //964; //1V7 = 916
//  printf("voltage = %2.2f\n", voltage);
//
//  float resistance = (voltage * 1000) / (3.5f - voltage);
//  printf("resistance = %4.2f\n", resistance);

  float voltage = (adc_value * 1.82f) / 2010; //1V82 = 2010
  //printf("voltage = %2.2f\n", voltage);

  float resistance = (voltage * 1000) / (3.5f - voltage);
  //printf("resistance = %4.2f\n", resistance);

  uint16_t size = sizeof(PT1000) / sizeof(*PT1000);
  if((PT1000[0][1] <= resistance) && (resistance <= PT1000[size - 1][1]))
  {
    for(uint16_t i = 0; i < size - 1; i++)
    {
      if(resistance < PT1000[i][1])
      {
        temperature = PT1000[i-1][0];
        break;
      }
    }
  }
  else
  {
    temperature = -1000;
    printf("pt1000: error. resistance out of range\n");
  }

  return temperature;
}

/*****************************************************************************/
